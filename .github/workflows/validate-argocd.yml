name: Validate ArgoCD Applications

on:
  pull_request:
    branches: [ main, staging ]
  push:
    branches: [ main, staging ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install pyyaml
        run: pip install pyyaml

      - name: Validate ArgoCD Applications
        run: |
          python - <<'PY'
          import sys, yaml, pathlib

          def load(path):
              with open(path, 'r', encoding='utf-8') as f:
                  return yaml.safe_load(f)

          root = pathlib.Path('argocd')
          staging = load(root / 'staging-app.yaml')
          prod = load(root / 'production-app.yaml')

          errors = []

          # Staging expectations
          try:
              s_src = staging['spec']['source']
              s_dest = staging['spec']['destination']
              s_values = s_src.get('helm', {}).get('valueFiles', [])
              if s_src.get('targetRevision') != 'staging':
                  errors.append('staging-app: targetRevision must be "staging"')
              if s_src.get('path') != 'charts/openanonymiser':
                  errors.append('staging-app: path must be charts/openanonymiser')
              if 'values-staging.yaml' not in s_values:
                  errors.append('staging-app: helm.valueFiles must include values-staging.yaml')
              if s_dest.get('namespace') != 'openanonymiser-staging':
                  errors.append('staging-app: namespace must be openanonymiser-staging')
          except Exception as e:
              errors.append(f'staging-app: parse error: {e}')

          # Production expectations
          try:
              p_src = prod['spec']['source']
              p_dest = prod['spec']['destination']
              p_values = p_src.get('helm', {}).get('valueFiles', [])
              if p_src.get('targetRevision') != 'main':
                  errors.append('production-app: targetRevision must be "main"')
              if p_src.get('path') != 'charts/openanonymiser':
                  errors.append('production-app: path must be charts/openanonymiser')
              if p_values:
                  errors.append('production-app: helm.valueFiles must be empty (use default values.yaml)')
              if p_dest.get('namespace') != 'openanonymiser':
                  errors.append('production-app: namespace must be openanonymiser')
          except Exception as e:
              errors.append(f'production-app: parse error: {e}')

          if errors:
              print('Validation errors:')
              for e in errors:
                  print('-', e)
              sys.exit(1)
          else:
              print('ArgoCD Applications validation passed.')
          PY


